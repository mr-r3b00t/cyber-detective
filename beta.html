<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyber Noir Detective</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    body {
      background: #000;
      color: #fff;
      font-family: 'Oswald', monospace;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .comic-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .panel {
      max-width: 100%;
      aspect-ratio: 4 / 3;
      border: 3px solid #fff;
      border-image: linear-gradient(to bottom, #fff, #0ff, #fff) 1;
      box-shadow: 0 0 15px #0ff, 0 0 30px #f0f, inset 0 0 5px #000;
      margin-bottom: 30px;
      background: #000;
      position: relative;
      transform: rotate(-1deg);
      transition: opacity 0.5s ease-in-out;
      animation: panelGlow 4s infinite alternate;
    }

    .panel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: none;
      animation: glitchFlicker 10s infinite;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('assets/grain.png') repeat;
      opacity: 0.3;
      pointer-events: none;
    }

    .panel::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkilibrioYAAAE3UlEQVR4nO2d25LjIAxFTf7/p7unqvthMhvbgC4IhM+uymMwAnS1DbhcPB6Px+PxeDwej8fj8Xg8Hs/7+AtuA3/2JpiD9QAAAABJRU5ErkJggg==') repeat;
      background-size: 100px;
      mix-blend-mode: overlay;
      opacity: 0.05;
      pointer-events: none;
      z-index: 3;
      animation: digitalNoise 4s infinite steps(4);
    }

    .narration {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      font-size: 1.1em;
      text-align: center;
      border-top: 2px solid #fff;
      position: absolute;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
      text-shadow: 0 0 8px #0ff;
    }

    .ending {
      font-size: 1.3em;
      color: #0ff;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 10px #0ff;
    }

    .choices {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      transition: opacity 0.5s ease-in-out;
      min-height: 40px;
    }

    .choices button {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.9em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 5px #0ff;
      tabindex: 0;
    }

    .choices button:hover, .choices button:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 15px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .restart, .tweet, .fullscreen {
      background: #000;
      color: #f00;
      border: 2px solid #f00;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      margin: 10px auto;
      display: block;
      transition: all 0.3s;
      box-shadow: 0 0 10px #f00;
    }

    .tweet {
      color: #0ff;
      border-color: #0ff;
      box-shadow: 0 0 10px #0ff;
    }

    .fullscreen {
      color: #fff;
      border-color: #fff;
      box-shadow: 0 0 10px #fff;
    }

    .restart:hover, .restart:focus {
      background: #f00;
      color: #000;
      box-shadow: 0 0 20px #f00;
      outline: 3px solid #f00;
      outline-offset: 2px;
    }

    .tweet:hover, .tweet:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .fullscreen:hover, .fullscreen:focus {
      background: #fff;
      color: #000;
      box-shadow: 0 0 20px #fff;
      outline: 3px solid #fff;
      outline-offset: 2px;
    }

    .audio-control {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      z-index: 10;
    }

    .audio-control:hover, .audio-control:focus {
      background: rgba(0, 255, 255, 0.5);
      transform: scale(1.1);
      outline: none;
      box-shadow: 0 0 10px #0ff;
    }

    .audio-control span {
      color: #0ff;
      font-size: 20px;
      line-height: 1;
    }

    .modal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #111;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff;
      padding: 20px;
      max-width: 500px;
      text-align: center;
      border-radius: 5px;
    }

    .modal-logo {
      max-width: 200px;
      display: block;
      margin: 0 auto 20px;
      filter: brightness(1.2);
      box-shadow: 0 0 10px #0ff;
    }

    .modal-content p {
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    .modal-content a {
      color: #0ff;
      text-decoration: none;
      transition: all 0.3s;
    }

    .modal-content a:hover, .modal-content a:focus {
      text-shadow: 0 0 10px #0ff;
      color: #fff;
    }

    .modal-content button {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 10px #0ff;
    }

    .modal-content button:hover, .modal-content button:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #111;
      border-top: 2px solid #0ff;
      margin-top: 20px;
      font-size: 0.9em;
      color: #fff;
      position: relative;
      width: 100%;
    }

    footer a {
      color: #0ff;
      text-decoration: none;
      transition: all 0.3s;
    }

    footer a:hover, footer a:focus {
      text-shadow: 0 0 10px #0ff;
      color: #fff;
    }

    :fullscreen .comic-container,
    :-webkit-full-screen .comic-container,
    :-moz-full-screen .comic-container {
      max-width: 100vw;
      padding: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    :fullscreen .panel,
    :-webkit-full-screen .panel,
    :-moz-full-screen .panel {
      max-width: 95vw;
      max-height: 85vh;
      width: 100%;
      height: auto;
      transform: none;
      margin-bottom: 10px;
      border-width: 2px;
    }

    :fullscreen .narration,
    :-webkit-full-screen .narration,
    :-moz-full-screen .narration {
      font-size: 1.8em;
      padding: 10px;
    }

    :fullscreen .choices,
    :-webkit-full-screen .choices,
    :-moz-full-screen .choices {
      min-height: 50px;
      gap: 8px;
      margin-bottom: 5px;
    }

    :fullscreen .choices button,
    :-webkit-full-screen .choices button,
    :-moz-full-screen .choices button {
      font-size: 1.4em;
      padding: 10px 20px;
    }

    :fullscreen .restart, :fullscreen .tweet, :fullscreen .fullscreen,
 Albuquerque, NM 87102
    :-webkit-full-screen .restart, :-webkit-full-screen .tweet, :-webkit-full-screen .fullscreen,
    :-moz-full-screen .restart, :-moz-full-screen .tweet, :-moz-full-screen .fullscreen {
      font-size: 1.4em;
      padding: 10px 20px;
      margin: 5px auto;
    }

    :fullscreen .audio-control,
    :-webkit-full-screen .audio-control,
    :-moz-full-screen .audio-control {
      top: 10px;
      right: 10px;
      width: 48px;
      height: 48px;
    }

    :fullscreen .audio-control span,
    :-webkit-full-screen .audio-control span,
    :-moz-full-screen .audio-control span {
      font-size: 24px;
    }

    @media (max-width: 600px) {
      .comic-container {
        padding: 10px;
      }

      .panel {
        max-width: 400px;
      }

      .narration {
        font-size: 0.9em;
        padding: 8px;
      }

      .choices button {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .ending {
        font-size: 1.1em;
      }

      .restart, .tweet {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .fullscreen {
        display: none;
      }

      .audio-control {
        width: 32px;
        height: 32px;
      }

      .audio-control span {
        font-size: 16px;
      }

      .modal-content {
        max-width: 90%;
        padding: 15px;
      }

      .modal-logo {
        max-width: 150px;
      }

      .modal-content p {
        font-size: 1em;
      }

      .modal-content button {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      footer {
        font-size: 0.8em;
        padding: 10px;
      }

      :fullscreen .panel,
      :-webkit-full-screen .panel,
      :-moz-full-screen .panel {
        max-width: 98vw;
        max-height: 80vh;
      }

      :fullscreen .narration,
      :-webkit-full-screen .narration,
      :-moz-full-screen .narration {
        font-size: 1.2em;
        padding: 8px;
      }

      :fullscreen .choices button,
      :-webkit-full-screen .choices button,
      :-moz-full-screen .choices button {
        font-size: 1em;
        padding: 8px 16px;
      }

      :fullscreen .restart, :fullscreen .tweet,
      :-webkit-full-screen .restart, :-webkit-full-screen .tweet,
      :-moz-full-screen .restart, :-moz-full-screen .tweet {
        font-size: 1em;
        padding: 8px 16px;
      }
    }

    @keyframes panelDraw {
      0% {
        clip-path: polygon(0 0, 0 0, 0 0, 0 0);
        filter: contrast(200%) brightness(0) grayscale(100%);
        transform: translateX(50px);
        box-shadow: 0 0 0 #0ff;
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        filter: none;
        transform: translateX(0);
        box-shadow: 0 0 15px #0ff, 0 0 30px #f0f;
      }
    }

    @keyframes panelErase {
      0% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        opacity: 1;
        transform: translateX(0);
        filter: none;
        box-shadow: 0 0 15px #0ff, 0 0 30px #f0f;
      }
      100% {
        clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
        opacity: 0;
        transform: translateX(-50px);
        filter: contrast(100%) brightness(0.2) grayscale(100%) hue-rotate(90deg);
        box-shadow: 0 0 0 transparent;
      }
    }

    @keyframes scanlines {
      0% {
        background-position: 0 0;
        opacity: 0;
      }
      50% {
        opacity: 0.2;
      }
      100% {
        background-position: 0 100%;
        opacity: 0;
      }
    }

    @keyframes digitalNoise {
      0%, 100% { background-position: 0 0; opacity: 0.03; }
      50% { background-position: -10% 10%; opacity: 0.06; }
    }

    @keyframes glitchFlicker {
      0%, 100% { opacity: 1; }
      10% { opacity: 0.8; }
      20% { opacity: 0.9; }
      30% { opacity: 0.7; }
    }

    @keyframes panelGlow {
      0%, 100% { box-shadow: 0 0 15px #0ff, 0 0 30px #f0f, inset 0 0 5px #000; }
      50% { box-shadow: 0 0 25px #0ff, 0 0 40px #f0f, inset 0 0 5px #000; }
    }

    @keyframes textReveal {
      0% {
        clip-path: polygon(0 0, 0 0, 0 0, 0 0);
        text-shadow: 0 0 0 transparent;
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        text-shadow: 0 0 8px #0ff, 0 0 5px #f0f;
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes glitchText {
      0%, 100% { transform: translate(0); text-shadow: 0 0 8px #0ff; }
      50% { transform: translate(-2px, 1px); text-shadow: -2px 0 #ff00c1, 2px 2px #0ff; }
    }

    .panel.transition-in {
      animation: panelDraw 0.8s ease-in-out forwards;
    }

    .panel.transition-in::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.2) 50%);
      background-size: 100% 4px;
      pointer-events: none;
      z-index: 2;
      animation: scanlines 1.5s linear forwards;
    }

    .panel.transition-out {
      animation: panelErase 0.8s ease-in-out forwards;
    }

    .narration.transition-in {
      animation: textReveal 0.7s ease-in-out 0.6s forwards;
    }

    .narration.glitch {
      animation: glitchText 5s infinite;
    }

    .choices.transition-in {
      animation: textReveal 0.5s ease-in-out 0.8s forwards;
    }

    .choices.transition-in button {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .choices.transition-in button:nth-child(1) { transition-delay: 0.8s; }
    .choices.transition-in button:nth-child(2) { transition-delay: 0.9s; }
    .choices.transition-in button:nth-child(3) { transition-delay: 1s; }
    .choices.transition-in button:nth-child(4) { transition-delay: 1.1s; }

    .choices.buttons-visible button {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="modal" id="welcome-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true" tabindex="-1">
    <div class="modal-content">
      <h2 id="modal-title" class="sr-only">Welcome to Cyber Noir</h2>
      <img src="assets/pwndefend.png" alt="PwnDefend Logo" class="modal-logo">
      <p>Welcome to Cyber Noire! This is a mini choose your own adventure cyber detective game created by <a href="https://www.pwndefend.com" target="_blank">https://www.pwndefend.com</a></p>
      <button id="play-button" tabindex="0">PLAY</button>
    </div>
  </div>
  <div class="comic-container">
    <div class="panel" id="panel">
      <img src="assets/panel1.jpg" alt="Comic panel" id="panel-image">
      <div class="narration" id="narration" aria-live="polite" aria-atomic="true"></div>
    </div>
    <div class="ending" id="ending" aria-live="polite" aria-atomic="true"></div>
    <div class="choices" id="choices"></div>
    <button class="restart" id="restart" style="display: none;">Restart Case</button>
    <button class="tweet" id="tweet" style="display: none;">Tweet Your Outcome</button>
    <button class="fullscreen" id="fullscreen">Enter Full Screen</button>
    <div class="audio-control" id="audio-control" role="button" tabindex="0" aria-label="Pause background audio">
      <span>⏸</span>
    </div>
  </div>
  <audio id="background-rain" autoplay loop>
    <source src="assets/rain.mp3" type="audio/mpeg">
    Your browser does not support the audio element. Please use a modern browser to experience the full audio effects.
  </audio>
  <footer role="contentinfo">
    Copyright © Xservus Limited. Created by mrr3b00t. <a href="https://www.pwndefend.com" target="_blank">www.pwndefend.com</a>
  </footer>

  <script>
    let story = {};
    let currentState = localStorage.getItem("currentState") || "start";
    const fallbackImage = "assets/fallback.jpg";
    let lastPlayedEnding = null;
    let hasInteracted = false;
    let themeTune = null;

    // Track user interaction
    document.addEventListener('click', () => {
      hasInteracted = true;
      console.log("User interaction detected, hasInteracted set to true");
    }, { once: true });

    // Modal handling
    const welcomeModal = document.getElementById("welcome-modal");
    const playButton = document.getElementById("play-button");

    playButton.focus();
    playButton.onclick = () => {
      welcomeModal.style.display = "none";
      hasInteracted = true;
      console.log("Play button clicked, starting game");

      // Play theme tune once
      themeTune = new Audio('assets/track01.mp3');
      themeTune.volume = 0.5;
      themeTune.onerror = () => console.error("Failed to load theme tune: assets/track01.mp3");
      themeTune.onended = () => updateAudioControl();
      themeTune.play().catch(err => console.error("Theme tune play failed:", err));

      loadStory();
    };

    playButton.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        playButton.click();
      }
    };

    // Audio controls
    const rainAudio = document.getElementById("background-rain");
    rainAudio.volume = 0.3;
    const audioControl = document.getElementById("audio-control");

    rainAudio.onerror = () => {
      console.error("Failed to load rain audio");
      document.getElementById("narration").textContent += " (Audio unavailable)";
      audioControl.setAttribute("aria-label", "Audio unavailable");
      audioControl.style.cursor = "not-allowed";
      audioControl.style.opacity = "0.5";
    };

    function updateAudioControl() {
      const isRainPaused = rainAudio.paused;
      const isThemePaused = !themeTune || themeTune.paused || themeTune.ended;
      const isPaused = isRainPaused && isThemePaused;
      audioControl.querySelector("span").textContent = isPaused ? "▶" : "⏸";
      audioControl.setAttribute("aria-label", isPaused ? "Play background audio" : "Pause background audio");
    }

    audioControl.onclick = () => {
      const isRainPaused = rainAudio.paused;
      const isThemePaused = !themeTune || themeTune.paused || themeTune.ended;

      if (isRainPaused && isThemePaused) {
        rainAudio.play().catch(err => console.error("Rain audio play failed:", err));
        if (themeTune && !themeTune.ended) {
          themeTune.play().catch(err => console.error("Theme tune play failed:", err));
        }
      } else {
        if (!isRainPaused) {
          rainAudio.pause();
        }
        if (themeTune && !themeTune.paused && !themeTune.ended) {
          themeTune.pause();
        }
      }
      updateAudioControl();
      hasInteracted = true;
    };

    audioControl.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        audioControl.click();
      }
    };

    rainAudio.onplay = updateAudioControl;
    rainAudio.onpause = updateAudioControl;

    if (hasInteracted) {
      rainAudio.play().catch(() => {
        console.log("Autoplay blocked, waiting for user interaction");
        updateAudioControl();
      });
    } else {
      console.log("Waiting for user interaction to play audio");
      document.addEventListener("click", () => {
        rainAudio.play().catch(() => console.log("Still blocked"));
      }, { once: true });
    }

    // Full-screen functionality
    const fullscreenButton = document.getElementById("fullscreen");
    fullscreenButton.onclick = toggleFullScreen;

    function toggleFullScreen() {
      const docEl = document.documentElement;
      const requestFullScreen = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen;
      if (!requestFullScreen) {
        console.warn("Fullscreen not supported");
        fullscreenButton.disabled = true;
        fullscreenButton.textContent = "Full Screen Unavailable";
        return;
      }
      if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
        requestFullScreen.call(docEl).then(() => {
          fullscreenButton.textContent = "Exit Full Screen";
        }).catch(err => console.error("Error entering full-screen mode:", err));
      } else {
        const exitFullScreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen;
        exitFullScreen.call(document).then(() => {
          fullscreenButton.textContent = "Enter Full Screen";
        }).catch(err => console.error("Error exiting full-screen mode:", err));
      }
      hasInteracted = true;
    }

    ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange'].forEach(event => {
      document.addEventListener(event, () => {
        fullscreenButton.textContent = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement
          ? "Exit Full Screen"
          : "Enter Full Screen";
      });
    });

    // Load story
    function loadStory(retries = 3) {
      console.log(`Loading story, retries left: ${retries}, currentState: ${currentState}`);
      fetch('assets/story.json', { mode: 'same-origin' })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load story.json: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Story loaded:", data);
          story = data;
          if (!story[currentState]) {
            console.warn(`State ${currentState} not found, resetting to start`);
            currentState = "start";
            try {
              localStorage.setItem("currentState", currentState);
            } catch (e) {
              console.warn("localStorage unavailable:", e);
            }
          }
          render();
        })
        .catch(error => {
          console.error(`Error loading story: ${error.message}`);
          let userMessage = "Failed to load story. Please try again.";
          if (error.message.includes("404")) {
            userMessage = "Story file not found. Contact the administrator.";
          } else if (error.message.includes("Failed to fetch")) {
            userMessage = "Network error. Check your connection and try again.";
          } else if (error.message.includes("Unexpected token")) {
            userMessage = "Invalid story file format. Contact the administrator.";
          }

          if (retries > 0 && !error.message.includes("404") && !error.message.includes("Unexpected token")) {
            setTimeout(() => loadStory(retries - 1), 2000 + Math.random() * 100);
          } else {
            document.getElementById("narration").textContent = userMessage;
            const retryButton = document.createElement("button");
            retryButton.textContent = "Retry";
            retryButton.className = "restart";
            retryButton.setAttribute("aria-label", "Retry loading story");
            retryButton.onclick = () => loadStory(3);
            document.getElementById("choices").appendChild(retryButton);
            story = {
              start: {
                text: "Error: Story failed to load. You're in Neon City, but the case is cold. Try again?",
                image: "assets/fallback.jpg",
                alt: "Error placeholder",
                choices: [{ text: "Retry", next: "start" }]
              }
            };
            console.log("Using fallback story:", story);
            render();
          }
        });
    }

    function render() {
      const panel = document.getElementById("panel");
      const narration = document.getElementById("narration");
      const ending = document.getElementById("ending");
      const choicesDiv = document.getElementById("choices");
      const panelImage = document.getElementById("panel-image");
      const restartButton = document.getElementById("restart");
      const tweetButton = document.getElementById("tweet");
      if (!panel || !narration || !ending || !choicesDiv || !panelImage || !restartButton || !tweetButton) {
        console.error("Required DOM elements missing:", { panel, narration, ending, choicesDiv, panelImage, restartButton, tweetButton });
        return;
      }

      try {
        const current = story[currentState];
        if (!current) {
          console.error(`No story state found for ${currentState}`);
          narration.textContent = "Error: Story state not found.";
          panelImage.src = fallbackImage;
          panelImage.alt = "Error placeholder";
          choicesDiv.innerHTML = "";
          return;
        }

        console.log(`Rendering state: ${currentState}`, current);

        // Remove previous transition classes
        panel.classList.remove("transition-in", "transition-out");
        narration.classList.remove("transition-in", "glitch");
        choicesDiv.classList.remove("transition-in", "buttons-visible");
        
        // Reset any filters
        panel.style.filter = "none";
        panelImage.style.filter = "none";

        // Apply transition out effect
        panel.classList.add("transition-out");
        
        // Update content and apply transition in effect
        setTimeout(() => {
          // Update content
          narration.textContent = current.text || "No narration available.";
          panelImage.src = current.image || fallbackImage;
          panelImage.alt = current.alt || `Cyber-noir comic scene: ${current.text?.slice(0, 50) || "Unknown"}...`;
          panelImage.onerror = () => { panelImage.src = fallbackImage; };
          ending.textContent = current.ending || "";
          choicesDiv.innerHTML = "";

          // Apply transition in effects
          panel.classList.remove("transition-out");
          panel.classList.add("transition-in");
          narration.classList.add("transition-in");
          choicesDiv.classList.add("transition-in");

          // Clear filter after animation
          setTimeout(() => {
            panel.style.filter = "none";
            panelImage.style.filter = "none";
            panel.classList.remove("transition-in");
          }, 800);

          if (!current.choices || current.choices.length === 0) {
            restartButton.style.display = "block";
            tweetButton.style.display = "block";
            const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
            const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
            const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
            console.log(`Checking ending: ${currentState}, Success: ${successEndings.includes(currentState)}, Partial Success: ${partialSuccessEndings.includes(currentState)}, Failure: ${failureEndings.includes(currentState)}`);
            if (hasInteracted && currentState !== lastPlayedEnding) {
              if (successEndings.includes(currentState)) {
                console.log("Triggering success sound");
                playOutcomeSound("success");
              } else if (partialSuccessEndings.includes(currentState)) {
                console.log("Triggering partial success sound");
                playOutcomeSound("partial-success");
              } else if (failureEndings.includes(currentState)) {
                console.log("Triggering failure sound");
                playOutcomeSound("failure");
              } else {
                console.log("No outcome sound for this ending");
              }
              lastPlayedEnding = currentState;
            } else {
              console.log(`Skipping sound: hasInteracted=${hasInteracted}, lastPlayedEnding=${lastPlayedEnding}`);
            }
          } else {
            restartButton.style.display = "none";
            tweetButton.style.display = "none";
          }

          const choices = Array.isArray(current.choices) ? current.choices : [];
          console.log(`Choices for ${currentState}:`, choices);
          if (choices.length === 0 && current.choices) {
            console.warn("No valid choices found for state:", currentState, current);
            narration.textContent = "Error: No valid choices available.";
            return;
          }
          choices.forEach((choice, index) => {
            if (!choice.text || !choice.next) {
              console.warn(`Invalid choice at index ${index}:`, choice);
              return;
            }
            const button = document.createElement("button");
            button.textContent = choice.text;
            button.setAttribute("aria-label", `Progress story: ${choice.text}`);
            button.onclick = () => makeChoice(choice.next);
            button.tabIndex = 0;
            choicesDiv.appendChild(button);
          });

          // Show buttons with staggered animation
          setTimeout(() => {
            choicesDiv.classList.add("buttons-visible");
          }, 800);
        }, 800);
      } catch (err) {
        console.error("Error in render:", err);
        narration.textContent = "Error: Unable to render story state.";
      }
    }

    function makeChoice(nextState) {
      console.log(`makeChoice called with nextState: ${nextState}`);
      if (typeof nextState !== 'string' || !nextState) {
        console.error("Invalid nextState:", nextState);
        return;
      }
      if (currentState !== nextState) {
        console.log(`Transitioning from ${currentState} to ${nextState}`);
        playChoiceSound();
        currentState = nextState;
        try {
          localStorage.setItem("currentState", currentState);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
        }
        lastPlayedEnding = null;
        render();
      } else {
        console.log(`No transition needed: currentState=${currentState} equals nextState=${nextState}`);
      }
    }

    function playChoiceSound() {
      console.log("Playing choice sound");
      const sound = new Audio('assets/choice-click.mp3');
      sound.volume = 0.5;
      sound.onerror = () => console.error("Failed to load choice sound");
      sound.play().catch(err => console.error("Choice sound play failed:", err));
      hasInteracted = true;
    }

    function playOutcomeSound(type) {
      if (!hasInteracted) {
        console.log(`Skipping ${type} sound: No user interaction yet`);
        return;
      }
      console.log(`Attempting to play ${type} sound`);
      let soundFile;
      switch (type) {
        case "success":
          soundFile = 'assets/success-sound.mp3';
          break;
        case "failure":
          soundFile = 'assets/failure-sound.mp3';
          break;
        case "partial-success":
          soundFile = 'assets/partial-success-sound.mp3';
          break;
        default:
          console.error("Invalid outcome type:", type);
          return;
      }
      const sound = new Audio(soundFile);
      console.log(`Sound object created: src=${sound.src}`);
      sound.volume = 0.5;
      let retryCount = 0;
      const maxRetries = 3;
      let shownError = false;
      sound.onerror = () => {
        console.error(`Failed to load ${type} sound: ${soundFile}`);
        if (!shownError) {
          document.getElementById("narration").textContent += ` (${type} sound unavailable)`;
          shownError = true;
        }
      };
      const attemptPlay = () => {
        if (retryCount >= maxRetries) {
          console.log(`Max retries reached for ${type} sound`);
          if (!shownError) {
            document.getElementById("narration").textContent += ` (${type} sound play failed)`;
            shownError = true;
          }
          return;
        }
        sound.play().catch(err => {
          console.error(`${type} sound play failed:`, err);
          retryCount++;
          setTimeout(attemptPlay, 100);
        });
      };
      attemptPlay();
    }

    function restart() {
      console.log("Restarting story");
      currentState = "start";
      try {
        localStorage.setItem("currentState", currentState);
      } catch (e) {
        console.warn("localStorage unavailable:", e);
      }
      lastPlayedEnding = null;
      hasInteracted = true;
      render();
    }

    function tweetOutcome() {
      if (!story[currentState]) {
        console.error("No story state for tweet");
        return;
      }
      const current = story[currentState];
      let message = "";
      const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
      const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
      const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
      const link = window.location.href;

      if (successEndings.includes(currentState)) {
        message = `I cracked the case as Riley Voss in Neon City, saving NexCorp from a cyber breach! 🕵️‍♂️ Play Cyber Noir Detective to solve the case: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (partialSuccessEndings.includes(currentState)) {
        message = `Exposed the truth in Neon City as Riley Voss, but at a cost. NexCorp survived, barely. 🕵️‍♂️ Play Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (failureEndings.includes(currentState)) {
        message = `Failed the case in Neon City as Riley Voss. The hackers won, and I'm disgraced. 😔 Try Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      }

      const tweetUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(message)}`;
      window.open(tweetUrl, '_blank');
      hasInteracted = true;
    }

    document.getElementById("restart").onclick = restart;
    document.getElementById("tweet").onclick = tweetOutcome;
  </script>
</body>
</html>
