<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyber Noir Detective</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  <style>
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }

    body {
      background: #000;
      color: #fff;
      font-family: 'Oswald', monospace;
      margin: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .comic-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      max-height: 100vh;
      overflow-y: auto;
      padding: 10px;
      box-sizing: border-box;
    }

    .panel {
      width: 100%;
      max-width: min(90vw, 800px);
      aspect-ratio: 4 / 3;
      border: 3px solid #fff;
      border-image: linear-gradient(to bottom, #fff, #0ff, #fff) 1;
      box-shadow: 0 0 15px #0ff, 0 0 30px #f0f, inset 0 0 5px #000;
      margin-bottom: 20px;
      background: #000;
      position: relative;
      transform: rotate(-1deg);
      transition: opacity 0.5s ease-in-out;
      animation: panelGlow 4s infinite alternate;
    }

    .panel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: none;
      animation: glitchFlicker 10s infinite;
    }

    .panel img.noir-filter {
      filter: grayscale(100%) contrast(150%) brightness(90%);
      animation: none;
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('assets/grain.png') repeat;
      opacity: 0.3;
      pointer-events: none;
    }

    .panel::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAE3UlEQVR4nO2d25LjIAxFTf7/p7unqvthMhvbgC4IhM+uymMwAnS1DbhcPB6Px+PxeDwej8fj8Xg8Hs/7+AtuA3/2JpiD9QAAAABJRU5ErkJggg==') repeat;
      background-size: 100px;
      mix-blend-mode: overlay;
      opacity: 0.05;
      pointer-events: none;
      z-index: 3;
      animation: digitalNoise 4s infinite steps(4);
    }

    .info-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 30px;
      height: 30px;
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid #0ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
      z-index: 20;
    }

    .info-icon:hover, .info-icon:focus {
      background: rgba(0, 255, 255, 0.5);
      transform: scale(1.1);
      box-shadow: 0 0 10px #0ff;
      outline: none;
    }

    .info-icon svg {
      width: 20px;
      height: 20px;
      fill: #0ff;
    }

    .info-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff;
      padding: 20px;
      max-width: 500px;
      width: 90%;
      z-index: 1000;
      color: #fff;
      text-align: center;
      border-radius: 5px;
    }

    .info-modal-content {
      font-size: 1.1em;
      margin-bottom: 20px;
    }

    .info-modal-close {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.9em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 10px #0ff;
    }

    .info-modal-close:hover, .info-modal-close:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .narration {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      font-size: 1.1em;
      text-align: center;
      border-top: 2px solid #fff;
      position: absolute;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
      text-shadow: 0 0 8px #0ff;
      z-index: 10;
    }

    .ending {
      font-size: 1.3em;
      color: #0ff;
      text-align: center;
      margin: 10px 0;
      text-shadow: 0 0 10px #0ff;
      z-index: 20;
    }

    .choices {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      transition: opacity 0.5s ease-in-out;
      min-height: 40px;
      margin-bottom: 10px;
      z-index: 20;
    }

    .choices button {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.9em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 5px #0ff;
      tabindex: 0;
    }

    .choices button:hover, .choices button:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 15px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .menu-buttons {
      display: flex;
      flex-direction: row;
      gap: 10px;
      justify-content: center;
      margin: 10px 0;
      z-index: 20;
    }

    .restart, .tweet, .bluesky, .fullscreen {
      background: #000;
      color: #f00;
      border: 2px solid #f00;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s;
      box-shadow: 0 0 10px #f00;
    }

    .tweet {
      color: #0ff;
      border-color: #0ff;
      box-shadow: 0 0 10px #0ff;
    }

    .bluesky {
      color: #1DA1F2;
      border-color: #1DA1F2;
      box-shadow: 0 0 10px #1DA1F2;
    }

    .fullscreen {
      color: #fff;
      border-color: #fff;
      box-shadow: 0 0 10px #fff;
    }

    .restart:hover, .restart:focus {
      background: #f00;
      color: #000;
      box-shadow: 0 0 20px #f00;
      outline: 3px solid #f00;
      outline-offset: 2px;
    }

    .tweet:hover, .tweet:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .bluesky:hover, .bluesky:focus {
      background: #1DA1F2;
      color: #000;
      box-shadow: 0 0 20px #1DA1F2;
      outline: 3px solid #1DA1F2;
      outline-offset: 2px;
    }

    .fullscreen:hover, .fullscreen:focus {
      background: #fff;
      color: #000;
      box-shadow: 0 0 20px #fff;
      outline: 3px solid #fff;
      outline-offset: 2px;
    }

    .audio-control {
      position: fixed;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      z-index: 30;
    }

    .audio-control:hover, .audio-control:focus {
      background: rgba(0, 255, 255, 0.5);
      transform: scale(1.1);
      outline: none;
      box-shadow: 0 0 10px #0ff;
    }

    .audio-control span {
      color: #0ff;
      font-size: 20px;
      line-height: 1;
    }

    .noir-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid #0ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s, box-shadow 0.3s;
      z-index: 30;
    }

    .noir-toggle:hover, .noir-toggle:focus {
      background: rgba(0, 255, 255, 0.5);
      transform: scale(1.1);
      box-shadow: 0 0 10px #0ff;
      outline: none;
    }

    .noir-toggle svg {
      width: 24px;
      height: 24px;
      fill: #0ff;
      transition: fill 0.3s;
    }

    .noir-toggle.noir-active svg {
      fill: #fff;
    }

    .modal {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #111;
      border: 2px solid #0ff;
      box-shadow: 0 0 20px #0ff;
      padding: 20px;
      max-width: 500px;
      text-align: center;
      border-radius: 5px;
    }

    .modal-logo {
      max-width: 200px;
      display: block;
      margin: 0 auto 20px;
      filter: brightness(1.2);
      box-shadow: 0 0 10px #0ff;
    }

    .modal-content p {
      font-size: 1.2em;
      margin-bottom: 20px;
    }

    .modal-content a {
      color: #0ff;
      text-decoration: none;
      transition: all 0.3s;
    }

    .modal-content a:hover, .modal-content a:focus {
      text-shadow: 0 0 10px #0ff;
      color: #fff;
    }

    .modal-content button {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 10px #0ff;
    }

    .modal-content button:hover, .modal-content button:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    footer {
      text-align: center;
      padding: 10px;
      background: rgba(17, 17, 17, 0.8);
      border-top: 2px solid #0ff;
      font-size: 0.9em;
      color: #fff;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 5;
    }

    footer a {
      color: #0ff;
      text-decoration: none;
      transition: all 0.3s;
    }

    footer a:hover, footer a:focus {
      text-shadow: 0 0 10px #0ff;
      color: #fff;
    }

    :fullscreen .comic-container,
    :-webkit-full-screen .comic-container,
    :-moz-full-screen .comic-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      padding: 0;
      overflow: hidden;
      display: block;
    }

    :fullscreen .panel,
    :-webkit-full-screen .panel,
    :-moz-full-screen .panel {
      width: 100vw;
      height: 100vh;
      max-width: none;
      max-height: none;
      margin: 0;
      transform: none;
      border-width: 0;
      box-shadow: none;
      animation: none;
    }

    :fullscreen .panel img,
    :-webkit-full-screen .panel img,
    :-moz-full-screen .panel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      animation: none;
    }

    :fullscreen .info-icon,
    :-webkit-full-screen .info-icon,
    :-moz-full-screen .info-icon {
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
    }

    :fullscreen .info-icon svg,
    :-webkit-full-screen .info-icon svg,
    :-moz-full-screen .info-icon svg {
      width: 24px;
      height: 24px;
    }

    :fullscreen .narration,
    :-webkit-full-screen .narration,
    :-moz-full-screen .narration {
      font-size: 1.8em;
      padding: 15px;
      background: rgba(0, 0, 0, 0.85);
      position: fixed;
      bottom: 60px;
      width: 100%;
      z-index: 10;
    }

    :fullscreen .choices,
    :-webkit-full-screen .choices,
    :-moz-full-screen .choices {
      position: fixed;
      bottom: 120px;
      width: 100%;
      min-height: 50px;
      gap: 8px;
      margin-bottom: 0;
      z-index: 20;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      box-sizing: border-box;
    }

    :fullscreen .ending,
    :-webkit-full-screen .ending,
    :-moz-full-screen .ending {
      position: fixed;
      bottom: 180px;
      width: 100%;
      z-index: 20;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      box-sizing: border-box;
    }

    :fullscreen .menu-buttons,
    :-webkit-full-screen .menu-buttons,
    :-moz-full-screen .menu-buttons {
      position: fixed;
      bottom: 240px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 10px;
      justify-content: center;
      z-index: 20;
    }

    :fullscreen .audio-control,
    :-webkit-full-screen .audio-control,
    :-moz-full-screen .audio-control {
      top: 10px;
      right: 10px;
      width: 48px;
      height: 48px;
      z-index: 30;
    }

    :fullscreen .audio-control span,
    :-webkit-full-screen .audio-control span,
    :-moz-full-screen .audio-control span {
      font-size: 24px;
    }

    :fullscreen .noir-toggle,
    :-webkit-full-screen .noir-toggle,
    :-moz-full-screen .noir-toggle {
      top: 10px;
      left: 10px;
      width: 48px;
      height: 48px;
      z-index: 30;
    }

    :fullscreen .noir-toggle svg,
    :-webkit-full-screen .noir-toggle svg,
    :-moz-full-screen .noir-toggle svg {
      width: 28px;
      height: 28px;
    }

    @media (max-width: 600px) {
      .comic-container {
        padding: 5px;
      }

      .panel {
        max-width: 95vw;
      }

      .info-icon {
        width: 24px;
        height: 24px;
      }

      .info-icon svg {
        width: 16px;
        height: 16px;
      }

      .info-modal {
        max-width: 80%;
        padding: 15px;
      }

      .info-modal-content {
        font-size: 1em;
      }

      .info-modal-close {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .narration {
        font-size: 0.9em;
        padding: 8px;
      }

      .choices button {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .ending {
        font-size: 1.1em;
      }

      .menu-buttons {
        flex-direction: column;
        gap: 5px;
      }

      .restart, .tweet, .bluesky {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .fullscreen {
        display: none;
      }

      .audio-control {
        width: 32px;
        height: 32px;
      }

      .audio-control span {
        font-size: 16px;
      }

      .noir-toggle {
        width: 32px;
        height: 32px;
      }

      .noir-toggle svg {
        width: 20px;
        height: 20px;
      }

      .modal-content {
        max-width: 90%;
        padding: 15px;
      }

      .modal-logo {
        max-width: 150px;
      }

      .modal-content p {
        font-size: 1em;
      }

      .modal-content button {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      footer {
        font-size: 0.8em;
        padding: 5px;
      }

      :fullscreen .panel,
      :-webkit-full-screen .panel,
      :-moz-full-screen .panel {
        width: 100vw;
        height: 100vh;
      }

      :fullscreen .info-icon,
      :-webkit-full-screen .info-icon,
      :-moz-full-screen .info-icon {
        width: 30px;
        height: 30px;
      }

      :fullscreen .info-icon svg,
      :-webkit-full-screen .info-icon svg,
      :-moz-full-screen .info-icon svg {
        width: 20px;
        height: 20px;
      }

      :fullscreen .narration,
      :-webkit-full-screen .narration,
      :-moz-full-screen .narration {
        font-size: 1.2em;
        padding: 10px;
        bottom: 50px;
      }

      :fullscreen .choices,
      :-webkit-full-screen .choices,
      :-moz-full-screen .choices {
        bottom: 100px;
        padding: 5px;
      }

      :fullscreen .choices button,
      :-webkit-full-screen .choices button,
      :-moz-full-screen .choices button {
        font-size: 1em;
        padding: 8px 16px;
      }

      :fullscreen .ending,
      :-webkit-full-screen .ending,
      :-moz-full-screen .ending {
        bottom: 150px;
        font-size: 1em;
        padding: 5px;
      }

      :fullscreen .menu-buttons,
      :-webkit-full-screen .menu-buttons,
      :-moz-full-screen .menu-buttons {
        flex-direction: column;
        gap: 5px;
        bottom: 200px;
      }

      :fullscreen .audio-control,
      :-webkit-full-screen .audio-control,
      :-moz-full-screen .audio-control {
        width: 40px;
        height: 40px;
      }

      :fullscreen .audio-control span,
      :-webkit-full-screen .audio-control span,
      :-moz-full-screen .audio-control span {
        font-size: 20px;
      }

      :fullscreen .noir-toggle,
      :-webkit-full-screen .noir-toggle,
      :-moz-full-screen .noir-toggle {
        width: 40px;
        height: 40px;
      }

      :fullscreen .noir-toggle svg,
      :-webkit-full-screen .noir-toggle svg,
      :-moz-full-screen .noir-toggle svg {
        width: 24px;
        height: 24px;
      }
    }

    @keyframes panelDraw {
      0% {
        clip-path: polygon(0 0, 0 0, 0 0, 0 0);
        filter: contrast(200%) brightness(0) grayscale(100%);
        transform: translateX(50px);
        box-shadow: 0 0 0 #0ff;
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        filter: none;
        transform: translateX(0);
        box-shadow: 0 0 15px #0ff, 0 0 30px #f0f;
      }
    }

    @keyframes panelErase {
      0% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        opacity: 1;
        transform: translateX(0);
        filter: none;
        box-shadow: 0 0 15px #0ff, 0 0 30px #f0f;
      }
      100% {
        clip-path: polygon(0 0, 0 0, 0 100%, 0 100%);
        opacity: 0;
        transform: translateX(-50px);
        filter: contrast(100%) brightness(0.2) grayscale(100%) hue-rotate(90deg);
        box-shadow: 0 0 0 transparent;
      }
    }

    @keyframes scanlines {
      0% {
        background-position: 0 0;
        opacity: 0;
      }
      50% {
        opacity: 0.2;
      }
      100% {
        background-position: 0 100%;
        opacity: 0;
      }
    }

    @keyframes digitalNoise {
      0%, 100% { background-position: 0 0; opacity: 0.03; }
      50% { background-position: -10% 10%; opacity: 0.06; }
    }

    @keyframes glitchFlicker {
      0%, 100% { opacity: 1; }
      10% { opacity: 0.8; }
      20% { opacity: 0.9; }
      30% { opacity: 0.7; }
    }

    @keyframes panelGlow {
      0%, 100% { box-shadow: 0 0 15px #0ff, 0 0 30px #f0f, inset 0 0 5px #000; }
      50% { box-shadow: 0 0 25px #0ff, 0 0 40px #f0f, inset 0 0 5px #000; }
    }

    @keyframes textReveal {
      0% {
        clip-path: polygon(0 0, 0 0, 0 0, 0 0);
        text-shadow: 0 0 0 transparent;
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%);
        text-shadow: 0 0 8px #0ff, 0 0 5px #f0f;
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes glitchText {
      0%, 100% { transform: translate(0); text-shadow: 0 0 8px #0ff; }
      50% { transform: translate(-2px, 1px); text-shadow: -2px 0 #ff00c1, 2px 2px #0ff; }
    }

    .panel.transition-in {
      animation: panelDraw 0.8s ease-in-out forwards;
    }

    .panel.transition-in::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, transparent 50%, rgba(0, 0, 0, 0.2) 50%);
      background-size: 100% 4px;
      pointer-events: none;
      z-index: 2;
      animation: scanlines 1.5s linear forwards;
    }

    .panel.transition-out {
      animation: panelErase 0.8s ease-in-out forwards;
    }

    .narration.transition-in {
      animation: textReveal 0.7s ease-in-out 0.6s forwards;
    }

    .narration.glitch {
      animation: glitchText 5s infinite;
    }

    .choices.transition-in {
      animation: textReveal 0.5s ease-in-out 0.8s forwards;
    }

    .choices.transition-in button {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }

    .choices.transition-in button:nth-child(1) { transition-delay: 0.8s; }
    .choices.transition-in button:nth-child(2) { transition-delay: 0.9s; }
    .choices.transition-in button:nth-child(3) { transition-delay: 1s; }
    .choices.transition-in button:nth-child(4) { transition-delay: 1.1s; }

    .choices.buttons-visible button {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="modal" id="welcome-modal" role="dialog" aria-labelledby="modal-title" aria-modal="true" tabindex="-1">
    <div class="modal-content">
      <h2 id="modal-title" class="sr-only">Welcome to Cyber Noir</h2>
      <img src="assets/pwndefend.png" alt="PwnDefend Logo" class="modal-logo">
      <p>Welcome to Cyber Noire! This is a mini choose your own adventure cyber detective game created by <a href="https://www.pwndefend.com" target="_blank">https://www.pwndefend.com</a></p>
      <button id="play-button" tabindex="0">PLAY</button>
    </div>
  </div>
  <div class="comic-container">
    <div class="panel" id="panel">
      <img src="assets/panel1.jpg" alt="Comic panel" id="panel-image">
      <div class="narration" id="narration" aria-live="polite" aria-atomic="true"></div>
      <div class="info-icon" id="info-icon" role="button" tabindex="0" aria-label="View additional information">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v2h-2V7zm0 4h2v6h-2v-6z"/>
        </svg>
      </div>
    </div>
    <div class="ending" id="ending" aria-live="polite" aria-atomic="true"></div>
    <div class="choices" id="choices"></div>
    <div class="menu-buttons">
      <button class="restart" id="restart" style="display: none;">Restart Case</button>
      <button class="tweet" id="tweet" style="display: none;">Tweet Your Outcome</button>
      <button class="bluesky" id="bluesky" style="display: none;">Post to Bluesky</button>
      <button class="fullscreen" id="fullscreen">Enter Full Screen</button>
    </div>
    <div class="audio-control" id="audio-control" role="button" tabindex="0" aria-label="Pause background audio">
      <span>‚è∏</span>
    </div>
    <div class="noir-toggle" id="noir-toggle" role="button" tabindex="0" aria-label="Enable noir filter">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v2h-2V7zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2z"/>
      </svg>
    </div>
    <div class="info-modal" id="info-modal" role="dialog" aria-labelledby="info-modal-title" aria-modal="true" tabindex="-1">
      <h2 id="info-modal-title" class="sr-only">Additional Information</h2>
      <p class="info-modal-content" id="info-modal-content"></p>
      <button class="info-modal-close" id="info-modal-close" aria-label="Close information modal">Close</button>
    </div>
  </div>
  <audio id="background-rain" autoplay loop>
    <source src="assets/rain.mp3" type="audio/mpeg">
    Your browser does not support the audio element. Please use a modern browser to experience the full audio effects.
  </audio>
  <footer role="contentinfo">
    Copyright ¬© Xservus Limited. Created by mrr3b00t. <a href="https://www.pwndefend.com" target="_blank">www.pwndefend.com</a>
  </footer>

  <script>
    let story = {};
    let currentState = localStorage.getItem("currentState") || "start";
    const fallbackImage = "assets/fallback.jpg";
    let lastPlayedEnding = null;
    let hasInteracted = false;
    let themeTune = null;
    let isFirstLoad = true; // Flag to track first load
    let isNoirActive = false; // Flag to track noir filter state

    // Track user interaction
    document.addEventListener('click', () => {
      hasInteracted = true;
      console.log("User interaction detected, hasInteracted set to true");
    }, { once: true });

    // Modal handling
    const welcomeModal = document.getElementById("welcome-modal");
    const playButton = document.getElementById("play-button");

    playButton.focus();
    playButton.onclick = () => {
      welcomeModal.style.display = "none";
      hasInteracted = true;
      console.log("Play button clicked, starting game");

      // Play theme tune once
      themeTune = new Audio('assets/track01.mp3');
      themeTune.volume = 0.5;
      themeTune.onerror = () => console.error("Failed to load theme tune: assets/track01.mp3");
      themeTune.onended = () => updateAudioControl();
      themeTune.play().catch(err => console.error("Theme tune play failed:", err));

      loadStory();
    };

    playButton.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        playButton.click();
      }
    };

    // Audio controls
    const rainAudio = document.getElementById("background-rain");
    rainAudio.volume = 0.3;
    const audioControl = document.getElementById("audio-control");

    rainAudio.onerror = () => {
      console.error("Failed to load rain audio");
      document.getElementById("narration").textContent += " (Audio unavailable)";
      audioControl.setAttribute("aria-label", "Audio unavailable");
      audioControl.style.cursor = "not-allowed";
      audioControl.style.opacity = "0.5";
    };

    function updateAudioControl() {
      const isRainPaused = rainAudio.paused;
      const isThemePaused = !themeTune || themeTune.paused || themeTune.ended;
      const isPaused = isRainPaused && isThemePaused;
      audioControl.querySelector("span").textContent = isPaused ? "‚ñ∂" : "‚è∏";
      audioControl.setAttribute("aria-label", isPaused ? "Play background audio" : "Pause background audio");
    }

    audioControl.onclick = () => {
      const isRainPaused = rainAudio.paused;
      const isThemePaused = !themeTune || themeTune.paused || themeTune.ended;

      if (isRainPaused && isThemePaused) {
        rainAudio.play().catch(err => console.error("Rain audio play failed:", err));
        if (themeTune && !themeTune.ended) {
          themeTune.play().catch(err => console.error("Theme tune play failed:", err));
        }
      } else {
        if (!isRainPaused) {
          rainAudio.pause();
        }
        if (themeTune && !themeTune.paused && !themeTune.ended) {
          themeTune.pause();
        }
      }
      updateAudioControl();
      hasInteracted = true;
    };

    audioControl.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        audioControl.click();
      }
    };

    rainAudio.onplay = updateAudioControl;
    rainAudio.onpause = updateAudioControl;

    if (hasInteracted) {
      rainAudio.play().catch(() => {
        console.log("Autoplay blocked, waiting for user interaction");
        updateAudioControl();
      });
    } else {
      console.log("Waiting for user interaction to play audio");
      document.addEventListener("click", () => {
        rainAudio.play().catch(() => console.log("Still blocked"));
      }, { once: true });
    }

    // Noir filter toggle
    const noirToggle = document.getElementById("noir-toggle");
    const panelImage = document.getElementById("panel-image");

    noirToggle.onclick = () => {
      isNoirActive = !isNoirActive;
      panelImage.classList.toggle("noir-filter", isNoirActive);
      noirToggle.setAttribute("aria-label", isNoirActive ? "Disable noir filter" : "Enable noir filter");
      noirToggle.classList.toggle("noir-active", isNoirActive);
      hasInteracted = true;
    };

    noirToggle.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        noirToggle.click();
      }
    };

    // Info modal handling
    const infoIcon = document.getElementById("info-icon");
    const infoModal = document.getElementById("info-modal");
    const infoModalContent = document.getElementById("info-modal-content");
    const infoModalClose = document.getElementById("info-modal-close");

    infoIcon.onclick = () => {
      const current = story[currentState];
      infoModalContent.textContent = current.info || "No additional information available.";
      infoModal.style.display = "block";
      infoModalClose.focus();
      hasInteracted = true;
    };

    infoIcon.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        infoIcon.click();
      }
    };

    infoModalClose.onclick = () => {
      infoModal.style.display = "none";
      infoIcon.focus();
    };

    infoModalClose.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        infoModalClose.click();
      }
    };

    // Trap focus in modal
    infoModal.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        const focusable = infoModalClose;
        if (document.activeElement === focusable && !e.shiftKey) {
          e.preventDefault();
          focusable.focus();
        }
      }
      if (e.key === 'Escape') {
        infoModalClose.click();
      }
    });

    // Full-screen functionality
    const fullscreenButton = document.getElementById("fullscreen");
    fullscreenButton.onclick = toggleFullScreen;

    function toggleFullScreen() {
      const docEl = document.documentElement;
      const requestFullScreen = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen;
      if (!requestFullScreen) {
        console.warn("Fullscreen not supported");
        fullscreenButton.disabled = true;
        fullscreenButton.textContent = "Full Screen Unavailable";
        return;
      }
      if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
        requestFullScreen.call(docEl).then(() => {
          fullscreenButton.textContent = "Exit Full Screen";
        }).catch(err => console.error("Error entering full-screen mode:", err));
      } else {
        const exitFullScreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen;
        exitFullScreen.call(document).then(() => {
          fullscreenButton.textContent = "Enter Full Screen";
        }).catch(err => console.error("Error exiting full-screen mode:", err));
      }
      hasInteracted = true;
    }

    ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange'].forEach(event => {
      document.addEventListener(event, () => {
        fullscreenButton.textContent = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement
          ? "Exit Full Screen"
          : "Enter Full Screen";
      });
    });

    // Load story
    function loadStory(retries = 3) {
      console.log(`Loading story, retries left: ${retries}, currentState: ${currentState}`);
      fetch('assets/story.json', { mode: 'same-origin' })
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load story.json: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Story loaded:", data);
          story = data;
          // Validate story structure
          validateStory(data);
          // Reset invalid state
          if (!story[currentState]) {
            console.warn(`State ${currentState} not found, resetting to start`);
            currentState = "start";
            try {
              localStorage.setItem("currentState", currentState);
            } catch (e) {
              console.warn("localStorage unavailable:", e);
            }
          }
          render();
        })
        .catch(error => {
          console.error(`Error loading story: ${error.message}`);
          let userMessage = "Failed to load story. Please try again.";
          if (error.message.includes("404")) {
            userMessage = "Story file not found. Contact the administrator.";
          } else if (error.message.includes("Failed to fetch")) {
            userMessage = "Network error. Check your connection and try again.";
          } else if (error.message.includes("Unexpected token")) {
            userMessage = "Invalid story file format. Contact the administrator.";
          }

          if (retries > 0 && !error.message.includes("404") && !error.message.includes("Unexpected token")) {
            setTimeout(() => loadStory(retries - 1), 2000 + Math.random() * 100);
          } else {
            document.getElementById("narration").textContent = userMessage;
            const retryButton = document.createElement("button");
            retryButton.textContent = "Retry";
            retryButton.className = "restart";
            retryButton.setAttribute("aria-label", "Retry loading story");
            retryButton.onclick = () => loadStory(3);
            document.getElementById("choices").appendChild(retryButton);
            story = {
              start: {
                text: "Error: Story failed to load. You're in Neon City, but the case is cold. Try again?",
                image: "assets/fallback.jpg",
                alt: "Error placeholder",
                choices: [{ text: "Retry", next: "start" }],
                info: "An error occurred loading the story data."
              }
            };
            console.log("Using fallback story:", story);
            render();
          }
        });
    }

    // Validate story.json structure
    function validateStory(story) {
      if (!story.start) {
        throw new Error("Story missing 'start' state");
      }
      const states = Object.keys(story);
      for (const state of states) {
        const node = story[state];
        if (!node.text || !node.image || !node.alt) {
          console.warn(`State '${state}' missing required properties: text, image, or alt`, node);
        }
        if (node.choices) {
          if (!Array.isArray(node.choices)) {
            console.warn(`State '${state}' has non-array choices:`, node.choices);
          } else {
            node.choices.forEach((choice, index) => {
              if (!choice.text || !choice.next) {
                console.warn(`Invalid choice at index ${index} in state '${state}':`, choice);
              } else if (!states.includes(choice.next)) {
                console.warn(`Choice at index ${index} in state '${state}' points to non-existent state '${choice.next}'`);
              }
            });
          }
        }
        // Info field is optional, no validation required
      }
    }

    function render() {
      const panel = document.getElementById("panel");
      const narration = document.getElementById("narration");
      const ending = document.getElementById("ending");
      const choicesDiv = document.getElementById("choices");
      const panelImage = document.getElementById("panel-image");
      const restartButton = document.getElementById("restart");
      const tweetButton = document.getElementById("tweet");
      const blueskyButton = document.getElementById("bluesky");
      if (!panel || !narration || !ending || !choicesDiv || !panelImage || !restartButton || !tweetButton || !blueskyButton) {
        console.error("Required DOM elements missing:", { panel, narration, ending, choicesDiv, panelImage, restartButton, tweetButton, blueskyButton });
        return;
      }

      try {
        const current = story[currentState];
        if (!current) {
          console.error(`No story state found for ${currentState}`);
          narration.textContent = "Error: Story state not found.";
          panelImage.src = fallbackImage;
          panelImage.alt = "Error placeholder";
          choicesDiv.innerHTML = "";
          return;
        }

        console.log(`Rendering state: ${currentState}`, current);

        // Hide info modal when changing states
        infoModal.style.display = "none";

        // Remove previous transition classes
        panel.classList.remove("transition-in", "transition-out");
        narration.classList.remove("transition-in", "glitch");
        choicesDiv.classList.remove("transition-in", "buttons-visible");
        
        // Reset panel filter, preserve noir-filter on image
        panel.style.filter = "none";
        if (!isNoirActive) {
          panelImage.classList.remove("noir-filter");
        } else {
          panelImage.classList.add("noir-filter");
        }

        // Apply transition out effect only if not first load
        if (!isFirstLoad) {
          panel.classList.add("transition-out");
        }

        // Update content and apply transition in effect
        setTimeout(() => {
          // Update content
          narration.textContent = current.text || "No narration available.";
          panelImage.src = current.image || fallbackImage;
          panelImage.alt = current.alt || `Cyber-noir comic scene: ${current.text?.slice(0, 50) || "Unknown"}...`;
          panelImage.onerror = () => { panelImage.src = fallbackImage; };
          ending.textContent = current.ending || "";
          choicesDiv.innerHTML = "";

          // Reapply noir filter if active
          if (isNoirActive) {
            panelImage.classList.add("noir-filter");
          }

          // Apply transition in effects only if not first load
          if (!isFirstLoad) {
            panel.classList.remove("transition-out");
            panel.classList.add("transition-in");
            narration.classList.add("transition-in");
            choicesDiv.classList.add("transition-in");
          }

          // Clear filter after animation (only if transition was applied, preserve noir-filter)
          setTimeout(() => {
            panel.style.filter = "none";
            if (!isNoirActive) {
              panelImage.classList.remove("noir-filter");
            }
            panel.classList.remove("transition-in");
          }, isFirstLoad ? 0 : 800);

          // Handle choices or ending
          const choices = Array.isArray(current.choices) ? current.choices : [];
          console.log(`Choices for ${currentState}:`, choices);

          if (!current.choices || choices.length === 0) {
            // Treat as an ending
            restartButton.style.display = "inline-block";
            tweetButton.style.display = "inline-block";
            blueskyButton.style.display = "inline-block";
            const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
            const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
            const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
            console.log(`Checking ending: ${currentState}, Success: ${successEndings.includes(currentState)}, Partial Success: ${partialSuccessEndings.includes(currentState)}, Failure: ${failureEndings.includes(currentState)}`);
            if (hasInteracted && currentState !== lastPlayedEnding) {
              if (successEndings.includes(currentState)) {
                console.log("Triggering success sound");
                playOutcomeSound("success");
              } else if (partialSuccessEndings.includes(currentState)) {
                console.log("Triggering partial success sound");
                playOutcomeSound("partial-success");
              } else if (failureEndings.includes(currentState)) {
                console.log("Triggering failure sound");
                playOutcomeSound("failure");
              } else {
                console.log("No outcome sound for this ending");
              }
              lastPlayedEnding = currentState;
            } else {
              console.log(`Skipping sound: hasInteracted=${hasInteracted}, lastPlayedEnding=${lastPlayedEnding}`);
            }
          } else {
            restartButton.style.display = "none";
            tweetButton.style.display = "none";
            blueskyButton.style.display = "none";
            // Validate choices
            let validChoices = 0;
            choices.forEach((choice, index) => {
              if (!choice.text || !choice.next) {
                console.warn(`Invalid choice at index ${index} in state ${currentState}:`, choice);
                return;
              }
              const button = document.createElement("button");
              button.textContent = choice.text;
              button.setAttribute("aria-label", `Progress story: ${choice.text}`);
              button.onclick = () => makeChoice(choice.next);
              button.tabIndex = 0;
              choicesDiv.appendChild(button);
              validChoices++;
            });
            if (validChoices === 0 && choices.length > 0) {
              console.error(`No valid choices in state ${currentState}:`, choices);
              narration.textContent = "Error: Invalid choices provided. Please restart.";
              restartButton.style.display = "inline-block";
              tweetButton.style.display = "inline-block";
              blueskyButton.style.display = "inline-block";
              return;
            }
          }

          // Show buttons with staggered animation (skip delay on first load)
          setTimeout(() => {
            choicesDiv.classList.add("buttons-visible");
          }, isFirstLoad ? 0 : 800);

          // Set isFirstLoad to false after first render
          isFirstLoad = false;
        }, isFirstLoad ? 0 : 800); // Skip delay on first load
      } catch (err) {
        console.error("Error in render:", err);
        narration.textContent = "Error: Unable to render story state.";
      }
    }

    function makeChoice(nextState) {
      console.log(`makeChoice called with nextState: ${nextState}`);
      if (typeof nextState !== 'string' || !nextState || !story[nextState]) {
        console.error(`Invalid or non-existent nextState: ${nextState}`);
        narration.textContent = "Error: Invalid story path. Resetting to start.";
        currentState = "start";
        try {
          localStorage.setItem("currentState", currentState);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
        }
        render();
        return;
      }
      if (currentState !== nextState) {
        console.log(`Transitioning from ${currentState} to ${nextState}`);
        playChoiceSound();
        currentState = nextState;
        try {
          localStorage.setItem("currentState", currentState);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
        }
        lastPlayedEnding = null;
        render();
      } else {
        console.log(`No transition needed: currentState=${currentState} equals nextState=${nextState}`);
      }
    }

    function playChoiceSound() {
      console.log("Playing choice sound");
      const sound = new Audio('assets/choice-click.mp3');
      sound.volume = 0.5;
      sound.onerror = () => console.error("Failed to load choice sound");
      sound.play().catch(err => console.error("Choice sound play failed:", err));
      hasInteracted = true;
    }

    function playOutcomeSound(type) {
      if (!hasInteracted) {
        console.log(`Skipping ${type} sound: No user interaction yet`);
        return;
      }
      console.log(`Attempting to play ${type} sound`);
      let soundFile;
      switch (type) {
        case "success":
          soundFile = 'assets/success-sound.mp3';
          break;
        case "failure":
          soundFile = 'assets/failure-sound.mp3';
          break;
        case "partial-success":
          soundFile = 'assets/partial-success-sound.mp3';
          break;
        default:
          console.error("Invalid outcome type:", type);
          return;
      }
      const sound = new Audio(soundFile);
      console.log(`Sound object created: src=${sound.src}`);
      sound.volume = 0.5;
      let retryCount = 0;
      const maxRetries = 3;
      let shownError = false;
      sound.onerror = () => {
        console.error(`Failed to load ${type} sound: ${soundFile}`);
        if (!shownError) {
          document.getElementById("narration").textContent += ` (${type} sound unavailable)`;
          shownError = true;
        }
      };
      const attemptPlay = () => {
        if (retryCount >= maxRetries) {
          console.log(`Max retries reached for ${type} sound`);
          if (!shownError) {
            document.getElementById("narration").textContent += ` (${type} sound play failed)`;
            shownError = true;
          }
          return;
        }
        sound.play().catch(err => {
          console.error(`${type} sound play failed:`, err);
          retryCount++;
          setTimeout(attemptPlay, 100);
        });
      };
      attemptPlay();
    }

    function restart() {
      console.log("Restarting story");
      currentState = "start";
      try {
        localStorage.setItem("currentState", currentState);
      } catch (e) {
        console.warn("localStorage unavailable:", e);
      }
      lastPlayedEnding = null;
      hasInteracted = true;
      render();
    }

    function tweetOutcome() {
      if (!story[currentState]) {
        console.error("No story state for tweet");
        return;
      }
      const current = story[currentState];
      let message = "";
      const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
      const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
      const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
      const link = window.location.href;

      if (successEndings.includes(currentState)) {
        message = `I cracked the case as Riley Voss in Neon City, saving NexCorp from a cyber breach! üïµÔ∏è‚Äç‚ôÇÔ∏è Play Cyber Noir Detective to solve the case: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (partialSuccessEndings.includes(currentState)) {
        message = `Exposed the truth in Neon City as Riley Voss, but at a cost. NexCorp survived, barely. üïµÔ∏è‚Äç‚ôÇÔ∏è Play Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (failureEndings.includes(currentState)) {
        message = `Failed the case in Neon City as Riley Voss. The hackers won, and I'm disgraced. üòî Try Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      }

      const tweetUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(message)}`;
      window.open(tweetUrl, '_blank');
      hasInteracted = true;
    }

    function postToBluesky() {
      if (!story[currentState]) {
        console.error("No story state for Bluesky post");
        return;
      }
      const current = story[currentState];
      let message = "";
      const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
      const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
      const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
      const link = window.location.href;

      if (successEndings.includes(currentState)) {
        message = `I cracked the case as Riley Voss in Neon City, saving NexCorp from a cyber breach! üïµÔ∏è‚Äç‚ôÇÔ∏è Play Cyber Noir Detective to solve the case: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (partialSuccessEndings.includes(currentState)) {
        message = `Exposed the truth in Neon City as Riley Voss, but at a cost. NexCorp survived, barely. üïµÔ∏è‚Äç‚ôÇÔ∏è Play Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (failureEndings.includes(currentState)) {
        message = `Failed the case in Neon City as Riley Voss. The hackers won, and I'm disgraced. üòî Try Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      }

      const blueskyUrl = `https://bsky.app/intent/compose?text=${encodeURIComponent(message)}`;
      window.open(blueskyUrl, '_blank');
      hasInteracted = true;
    }

    document.getElementById("restart").onclick = restart;
    document.getElementById("tweet").onclick = tweetOutcome;
    document.getElementById("bluesky").onclick = postToBluesky;
    document.getElementById("bluesky").onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        postToBluesky();
      }
    };

    // Reset invalid state on load
    if (!story[currentState]) {
      console.log("Invalid initial state, resetting to start");
      currentState = "start";
      try {
        localStorage.setItem("currentState", currentState);
      } catch (e) {
        console.warn("localStorage unavailable:", e);
      }
    }
  </script>
</body>
</html>
