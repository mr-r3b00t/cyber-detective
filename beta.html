<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cyber Noir Detective</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: 'Oswald', monospace;
      margin: 0;
      overflow-x: hidden;
    }

    .comic-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    .panel {
      max-width: 100%;
      aspect-ratio: 4 / 3;
      border: 3px solid #fff;
      border-image: linear-gradient(to bottom, #fff, #0ff, #fff) 1;
      box-shadow: 0 0 15px #0ff, 0 0 30px #f0f, inset 0 0 5px #000;
      margin-bottom: 30px;
      background: #000;
      position: relative;
      transform: rotate(-1deg);
      transition: opacity 0.5s ease-in-out;
    }

    .panel img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: contrast(200%) brightness(1.2) grayscale(100%);
    }

    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('assets/grain.png') repeat;
      opacity: 0.3;
      pointer-events: none;
    }

    .narration {
      background: rgba(0, 0, 0, 0.9);
      padding: 10px;
      font-size: 1.1em;
      text-align: center;
      border-top: 2px solid #fff;
      position: absolute;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
    }

    .ending {
      font-size: 1.3em;
      color: #0ff;
      text-align: center;
      margin: 20px 0;
      text-shadow: 0 0 10px #0ff;
    }

    .choices {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      transition: opacity 0.5s ease-in-out;
      min-height: 40px;
    }

    .choices button {
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 0.9em;
      text-transform: uppercase;
      transition: all 0.3s;
      box-shadow: 0 0 5px #0ff;
    }

    .choices button:hover, .choices button:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 15px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .restart, .tweet, .fullscreen {
      background: #000;
      color: #f00;
      border: 2px solid #f00;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 1em;
      margin: 10px auto;
      display: block;
      transition: all 0.3s;
      box-shadow: 0 0 10px #f00;
    }

    .tweet {
      color: #0ff;
      border-color: #0ff;
      box-shadow: 0 0 10px #0ff;
    }

    .fullscreen {
      color: #fff;
      border-color: #fff;
      box-shadow: 0 0 10px #fff;
    }

    .restart:hover, .restart:focus {
      background: #f00;
      color: #000;
      box-shadow: 0 0 20px #f00;
      outline: 3px solid #f00;
      outline-offset: 2px;
    }

    .tweet:hover, .tweet:focus {
      background: #0ff;
      color: #000;
      box-shadow: 0 0 20px #0ff;
      outline: 3px solid #0ff;
      outline-offset: 2px;
    }

    .fullscreen:hover, .fullscreen:focus {
      background: #fff;
      color: #000;
      box-shadow: 0 0 20px #fff;
      outline: 3px solid #fff;
      outline-offset: 2px;
    }

    .audio-control {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      z-index: 10;
    }

    .audio-control:hover, .audio-control:focus {
      background: rgba(0, 255, 255, 0.5);
      transform: scale(1.1);
      outline: none;
      box-shadow: 0 0 10px #0ff;
    }

    .audio-control span {
      color: #0ff;
      font-size: 20px;
      line-height: 1;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #111;
      border-top: 2px solid #0ff;
      margin-top: 20px;
      font-size: 0.9em;
      color: #fff;
    }

    footer a {
      color: #0ff;
      text-decoration: none;
      transition: all 0.3s;
    }

    footer a:hover, footer a:focus {
      text-shadow: 0 0 10px #0ff;
      color: #fff;
    }

    /* Full-screen styles */
    :fullscreen .comic-container,
    :-webkit-full-screen .comic-container,
    :-moz-full-screen .comic-container {
      max-width: 100vw;
      padding: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    :fullscreen .panel,
    :-webkit-full-screen .panel,
    :-moz-full-screen .panel {
      max-width: 95vw;
      max-height: 85vh;
      width: 100%;
      height: auto;
      transform: none;
      margin-bottom: 10px;
      border-width: 2px;
    }

    :fullscreen .narration,
    :-webkit-full-screen .narration,
    :-moz-full-screen .narration {
      font-size: 1.8em;
      padding: 10px;
    }

    :fullscreen .choices,
    :-webkit-full-screen .choices,
    :-moz-full-screen .choices {
      min-height: 50px;
      gap: 8px;
      margin-bottom: 5px;
    }

    :fullscreen .choices button,
    :-webkit-full-screen .choices button,
    :-moz-full-screen .choices button {
      font-size: 1.4em;
      padding: 10px 20px;
    }

    :fullscreen .restart, :fullscreen .tweet, :fullscreen .fullscreen,
    :-webkit-full-screen .restart, :-webkit-full-screen .tweet, :-webkit-full-screen .fullscreen,
    :-moz-full-screen .restart, :-moz-full-screen .tweet, :-moz-full-screen .fullscreen {
      font-size: 1.4em;
      padding: 10px 20px;
      margin: 5px auto;
    }

    :fullscreen .audio-control,
    :-webkit-full-screen .audio-control,
    :-moz-full-screen .audio-control {
      top: 10px;
      right: 10px;
      width: 48px;
      height: 48px;
    }

    :fullscreen .audio-control span,
    :-webkit-full-screen .audio-control span,
    :-moz-full-screen .audio-control span {
      font-size: 24px;
    }

    @media (max-width: 600px) {
      .comic-container {
        padding: 10px;
      }

      .panel {
        max-width: 400px;
      }

      .narration {
        font-size: 0.9em;
        padding: 8px;
      }

      .choices button {
        padding: 6px 12px;
        font-size: 0.8em;
      }

      .ending {
        font-size: 1.1em;
      }

      .restart, .tweet {
        padding: 8px 16px;
        font-size: 0.9em;
      }

      .fullscreen {
        display: none; /* Hide full-screen button on mobile */
      }

      .audio-control {
        width: 32px;
        height: 32px;
      }

      .audio-control span {
        font-size: 16px;
      }

      footer {
        font-size: 0.8em;
        padding: 10px;
      }

      :fullscreen .panel,
      :-webkit-full-screen .panel,
      :-moz-full-screen .panel {
        max-width: 98vw;
        max-height: 80vh;
      }

      :fullscreen .narration,
      :-webkit-full-screen .narration,
      :-moz-full-screen .narration {
        font-size: 1.2em;
        padding: 8px;
      }

      :fullscreen .choices button,
      :-webkit-full-screen .choices button,
      :-moz-full-screen .choices button {
        font-size: 1em;
        padding: 8px 16px;
      }

      :fullscreen .restart, :fullscreen .tweet,
      :-webkit-full-screen .restart, :-webkit-full-screen .tweet,
      :-moz-full-screen .restart, :-moz-full-screen .tweet {
        font-size: 1em;
        padding: 8px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="comic-container">
    <div class="panel" id="panel">
      <img src="assets/panel1.jpg" alt="Comic panel" id="panel-image">
      <div class="narration" id="narration" aria-live="polite"></div>
    </div>
    <div class="ending" id="ending" aria-live="polite"></div>
    <div class="choices" id="choices"></div>
    <button class="restart" id="restart" style="display: none;">Restart Case</button>
    <button class="tweet" id="tweet" style="display: none;">Tweet Your Outcome</button>
    <button class="fullscreen" id="fullscreen">Enter Full Screen</button>
    <div class="audio-control" id="audio-control" role="button" tabindex="0" aria-label="Pause background rain audio">
      <span>⏸</span>
    </div>
  </div>
  <audio id="background-rain" autoplay loop>
    <source src="assets/rain.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
  </audio>
  <footer>
    Copyright © Xservus Limited. Created by mrr3b00t. <a href="https://www.pwndefend.com" target="_blank">www.pwndefend.com</a>
  </footer>

  <script>
    let story = {};
    let currentState = localStorage.getItem("currentState") || "start";
    const fallbackImage = "assets/fallback.jpg";

    // Audio controls
    const rainAudio = document.getElementById("background-rain");
    rainAudio.volume = 0.3;
    const audioControl = document.getElementById("audio-control");

    rainAudio.onerror = () => {
      console.error("Failed to load rain audio");
      document.getElementById("narration").textContent += " (Audio unavailable)";
      audioControl.setAttribute("aria-label", "Audio unavailable");
      audioControl.style.cursor = "not-allowed";
      audioControl.style.opacity = "0.5";
    };

    function playChoiceSound() {
      const sound = new Audio('assets/choice-click.mp3');
      sound.volume = 0.5;
      sound.onerror = () => console.error("Failed to load choice sound");
      sound.play().catch(err => console.error("Choice sound play failed:", err));
    }

    function updateAudioControl() {
      audioControl.querySelector("span").textContent = rainAudio.paused ? "▶" : "⏸";
      audioControl.setAttribute("aria-label", rainAudio.paused ? "Play background rain audio" : "Pause background rain audio");
    }

    audioControl.onclick = () => {
      if (rainAudio.paused) {
        rainAudio.play().catch(err => console.error("Audio play failed:", err));
      } else {
        rainAudio.pause();
      }
      updateAudioControl();
    };

    audioControl.onkeydown = (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        audioControl.click();
      }
    };

    rainAudio.onplay = updateAudioControl;
    rainAudio.onpause = updateAudioControl;

    rainAudio.play().catch(() => {
      console.log("Autoplay blocked, waiting for user interaction");
      updateAudioControl();
      const tryPlay = () => {
        rainAudio.play().catch(() => console.log("Still blocked"));
        document.removeEventListener("click", tryPlay);
      };
      document.addEventListener("click", tryPlay, { once: true });
    });

    // Full-screen functionality
    const fullscreenButton = document.getElementById("fullscreen");
    fullscreenButton.onclick = toggleFullScreen;

    function toggleFullScreen() {
      const docEl = document.documentElement;
      const requestFullScreen = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.mozRequestFullScreen;
      if (!requestFullScreen) {
        console.warn("Fullscreen not supported");
        fullscreenButton.disabled = true;
        fullscreenButton.textContent = "Full Screen Unavailable";
        return;
      }
      if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement) {
        requestFullScreen.call(docEl).then(() => {
          fullscreenButton.textContent = "Exit Full Screen";
        }).catch(err => console.error("Error entering full-screen mode:", err));
      } else {
        const exitFullScreen = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen;
        exitFullScreen.call(document).then(() => {
          fullscreenButton.textContent = "Enter Full Screen";
        }).catch(err => console.error("Error exiting full-screen mode:", err));
      }
    }

    ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange'].forEach(event => {
      document.addEventListener(event, () => {
        fullscreenButton.textContent = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement
          ? "Exit Full Screen"
          : "Enter Full Screen";
      });
    });

    // Load story
    function loadStory(retries = 3) {
      console.log(`Loading story, retries left: ${retries}, currentState: ${currentState}`);
      fetch('assets/story.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load story.json: ${response.status} ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Story loaded:", data);
          story = data;
          if (!story[currentState]) {
            console.warn(`State ${currentState} not found, resetting to start`);
            currentState = "start";
            try {
              localStorage.setItem("currentState", currentState);
            } catch (e) {
              console.warn("localStorage unavailable:", e);
            }
          }
          render();
        })
        .catch(error => {
          console.error(`Error loading story: ${error.message}`);
          let userMessage = "Failed to load story. Please try again.";
          if (error.message.includes("404")) {
            userMessage = "Story file not found. Contact the administrator.";
          } else if (error.message.includes("Failed to fetch")) {
            userMessage = "Network error. Check your connection and try again.";
          } else if (error.message.includes("Unexpected token")) {
            userMessage = "Invalid story file format. Contact the administrator.";
          }

          if (retries > 0 && !error.message.includes("404") && !error.message.includes("Unexpected token")) {
            setTimeout(() => loadStory(retries - 1), 2000 + Math.random() * 100);
          } else {
            document.getElementById("narration").textContent = userMessage;
            const retryButton = document.createElement("button");
            retryButton.textContent = "Retry";
            retryButton.className = "restart";
            retryButton.setAttribute("aria-label", "Retry loading story");
            retryButton.onclick = () => loadStory(3);
            document.getElementById("choices").appendChild(retryButton);
            story = {
              start: {
                text: "Error: Story failed to load. You’re in Neon City, but the case is cold. Try again?",
                image: "assets/fallback.jpg",
                alt: "Error placeholder",
                choices: [{ text: "Retry", next: "start" }]
              }
            };
            console.log("Using fallback story:", story);
            render();
          }
        });
    }

    function render() {
      const panel = document.getElementById("panel");
      const narration = document.getElementById("narration");
      const ending = document.getElementById("ending");
      const choicesDiv = document.getElementById("choices");
      const panelImage = document.getElementById("panel-image");
      const restartButton = document.getElementById("restart");
      const tweetButton = document.getElementById("tweet");
      if (!panel || !narration || !ending || !choicesDiv || !panelImage) {
        console.error("Required DOM elements missing");
        return;
      }

      const current = story[currentState];
      if (!current) {
        console.error(`No story state found for ${currentState}`);
        narration.textContent = "Error: Story state not found.";
        panelImage.src = fallbackImage;
        panelImage.alt = "Error placeholder";
        choicesDiv.innerHTML = "";
        return;
      }

      console.log(`Rendering state: ${currentState}`, current);

      panel.style.opacity = 0;
      choicesDiv.style.opacity = 0;
      setTimeout(() => {
        panel.style.opacity = 1;
        choicesDiv.style.opacity = 1;
      }, 100);

      narration.textContent = current.text || "No narration available.";
      panelImage.src = current.image || fallbackImage;
      panelImage.alt = current.alt || `Cyber-noir comic scene: ${current.text?.slice(0, 50) || "Unknown"}...`;
      panelImage.onerror = () => { panelImage.src = fallbackImage; };
      ending.textContent = current.ending || "";
      choicesDiv.innerHTML = "";

      if (current.choices?.length === 0) {
        restartButton.style.display = "block";
        tweetButton.style.display = "block";
      } else {
        restartButton.style.display = "none";
        tweetButton.style.display = "none";
      }

      const choices = Array.isArray(current.choices) ? current.choices : [];
      console.log(`Choices for ${currentState}:`, choices);
      choices.forEach(choice => {
        if (!choice.text || !choice.next) {
          console.warn("Invalid choice:", choice);
          return;
        }
        const button = document.createElement("button");
        button.textContent = choice.text;
        button.setAttribute("aria-label", `Progress story: ${choice.text}`);
        button.onclick = () => makeChoice(choice.next);
        choicesDiv.appendChild(button);
      });
    }

    function makeChoice(nextState) {
      if (currentState !== nextState) {
        console.log(`Transitioning from ${currentState} to ${nextState}`);
        playChoiceSound();
        currentState = nextState;
        try {
          localStorage.setItem("currentState", currentState);
        } catch (e) {
          console.warn("localStorage unavailable:", e);
        }
        render();
      }
    }

    function restart() {
      console.log("Restarting story");
      currentState = "start";
      try {
        localStorage.setItem("currentState", currentState);
      } catch (e) {
        console.warn("localStorage unavailable:", e);
      }
      render();
    }

    function tweetOutcome() {
      if (!story[currentState]) {
        console.error("No story state for tweet");
        return;
      }
      const current = story[currentState];
      let message = "";
      const successEndings = ["lessons_internal_report", "lessons_external_report", "lessons_internal_warn", "lessons_external_warn"];
      const partialSuccessEndings = ["lessons_internal_expose", "lessons_external_expose", "lessons_internal_audit"];
      const failureEndings = ["fail_internal_lost", "fail_internal_wipe", "fail_internal_disgraced", "fail_external_missed", "fail_external_alienated", "fail_external_disgraced"];
      const link = "https://mr-r3b00t.github.io/cyber-detective/";

      if (successEndings.includes(currentState)) {
        message = `I cracked the case as Riley Voss in Neon City, saving NexCorp from a cyber breach! 🕵️‍♂️ Play Cyber Noir Detective to solve the case: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (partialSuccessEndings.includes(currentState)) {
        message = `Exposed the truth in Neon City as Riley Voss, but at a cost. NexCorp survived, barely. 🕵️‍♂️ Play Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      } else if (failureEndings.includes(currentState)) {
        message = `Failed the case in Neon City as Riley Voss. The hackers won, and I'm disgraced. 😔 Try Cyber Noir Detective: ${link} #CyberNoirDetective #Cyberpunk`;
      }

      const tweetUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(message)}`;
      window.open(tweetUrl, '_blank');
    }

    document.getElementById("restart").onclick = restart;
    document.getElementById("tweet").onclick = tweetOutcome;

    loadStory();
  </script>
</body>
</html>
